<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Async Jobs Test</title>
  <style>
    * { box-sizing: border-box; }
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 648px; 
      margin: 0 auto; 
      padding: 12px;
      background: #1a1a2e;
      color: #eee;
    }
    h1 { color: #00d4ff; margin-bottom: 12px; font-size: 22px; }
    .section { 
      background: #16213e; 
      padding: 12px; 
      border-radius: 6px; 
      margin-bottom: 12px;
    }
    .section h3 { margin: 0 0 8px 0; font-size: 14px; }
    label { display: block; margin-bottom: 3px; font-weight: 600; font-size: 12px; }
    input, textarea, button { 
      width: 100%; 
      padding: 6px; 
      margin-bottom: 10px;
      border: 1px solid #333;
      border-radius: 4px;
      background: #0f0f23;
      color: #eee;
      font-size: 13px;
    }
    button { 
      background: #00d4ff; 
      color: #000; 
      font-weight: bold; 
      cursor: pointer;
      border: none;
    }
    button:hover { background: #00b8e6; }
    button:disabled { background: #666; cursor: not-allowed; }
    .log { 
      background: #0a0a15; 
      padding: 10px; 
      border-radius: 4px; 
      font-family: monospace;
      font-size: 11px;
      max-height: 200px;
      overflow-y: auto;
      white-space: pre-wrap;
    }
    .log-entry { margin-bottom: 5px; }
    .log-time { color: #888; }
    .log-info { color: #00d4ff; }
    .log-success { color: #00ff88; }
    .log-error { color: #ff4444; }
    .log-warn { color: #ffaa00; }
    .status-badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 14px;
      font-weight: bold;
      text-transform: uppercase;
      font-size: 10px;
    }
    .status-queued { background: #666; }
    .status-processing { background: #ff9800; color: #000; }
    .status-done { background: #4caf50; }
    .status-error { background: #f44336; }
    .result-container {
      margin-top: 12px;
      margin-left: -12px;
      margin-right: -12px;
      margin-bottom: -12px;
    }
    .result-container h4 {
      margin: 0 0 8px 12px;
      font-size: 13px;
    }
    .result-image {
      width: 100%;
      display: block;
      border-radius: 0 0 6px 6px;
    }
    .timing-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 6px;
      margin-top: 10px;
    }
    .timing-box {
      background: #0a0a15;
      padding: 6px;
      border-radius: 4px;
      text-align: center;
    }
    .timing-value { font-size: 16px; font-weight: bold; color: #00d4ff; }
    .timing-label { font-size: 10px; color: #888; }

    /* Result panel thumbnails */
    .result-thumbnails {
      display: flex;
      justify-content: center;
      gap: 10px;
      padding: 12px;
      background: #fff;
    }
    .result-thumb {
      width: 56px;
      height: 56px;
      border-radius: 8px;
      border: 2px solid #e0e0e0;
      object-fit: cover;
      background: #f5f5f5;
    }
    .result-thumb.active {
      border-color: #7c3aed;
    }
    .result-thumb-add {
      width: 56px;
      height: 56px;
      border-radius: 8px;
      border: 2px dashed #ccc;
      background: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      color: #999;
      cursor: pointer;
      transition: border-color 0.2s, color 0.2s;
    }
    .result-thumb-add:hover {
      border-color: #7c3aed;
      color: #7c3aed;
    }
    .try-another-btn {
      display: block;
      width: calc(100% - 24px);
      margin: 0 12px 12px 12px;
      padding: 14px;
      background: linear-gradient(90deg, #f59e0b, #f97316);
      color: #fff;
      font-weight: bold;
      font-size: 15px;
      border: none;
      border-radius: 24px;
      cursor: pointer;
      text-align: center;
    }
    .try-another-btn:hover {
      background: linear-gradient(90deg, #d97706, #ea580c);
    }
    .result-close-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: rgba(0,0,0,0.5);
      color: #fff;
      border: none;
      cursor: pointer;
      font-size: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .result-close-btn:hover {
      background: rgba(0,0,0,0.7);
    }
    .result-image-wrapper {
      position: relative;
    }
  </style>
</head>
<body>
  <h1>üöÄ Async Jobs Test</h1>
  
  <div class="section">
    <h3>Configuration</h3>
    <label>API Key</label>
    <input type="text" id="apiKey" value="demotryon01">
    
    <label>API Base URL</label>
    <input type="text" id="baseUrl" value="">
    <small style="color:#888;font-size:11px">Leave empty for relative URLs</small>
  </div>

  <div class="section">
    <h3>Images</h3>
    <label>User Image (base64 or URL)</label>
    <textarea id="userImage" rows="2" placeholder="Paste base64 or URL..."></textarea>
    
    <label>Garment Image (base64 or URL)</label>
    <textarea id="garmentImage" rows="2" placeholder="Paste base64 or URL..."></textarea>
  </div>

  <div class="section">
    <button id="submitBtn" onclick="submitJob()">üöÄ Submit Async Job</button>
    <button id="healthBtn" onclick="checkHealth()" style="background:#333;color:#fff;margin-top:0;">üîç Check Health</button>
  </div>

  <div class="section">
    <h3>Job Status</h3>
    <div id="jobStatus">
      <span class="status-badge" style="background:#333">No job submitted</span>
    </div>
    
    <div id="timings" class="timing-grid" style="display:none">
      <div class="timing-box">
        <div class="timing-value" id="submitTime">-</div>
        <div class="timing-label">Submit (ms)</div>
      </div>
      <div class="timing-box">
        <div class="timing-value" id="queueTime">-</div>
        <div class="timing-label">Queue Wait (ms)</div>
      </div>
      <div class="timing-box">
        <div class="timing-value" id="falTime">-</div>
        <div class="timing-label">FAL Inference (ms)</div>
      </div>
      <div class="timing-box">
        <div class="timing-value" id="totalTime">-</div>
        <div class="timing-label">Total (ms)</div>
      </div>
    </div>
    
    <div id="resultContainer" class="result-container" style="display:none;">
      <div class="result-image-wrapper">
        <img id="resultImage" class="result-image" alt="Result">
        <button class="result-close-btn" onclick="closeResult()" title="Close">√ó</button>
      </div>
      <div class="result-thumbnails">
        <img id="thumbUser" class="result-thumb" alt="User" title="Your photo">
        <img id="thumbGarment" class="result-thumb active" alt="Garment" title="Garment used">
        <div class="result-thumb-add" onclick="addAnotherGarment()" title="Add another garment">+</div>
      </div>
      <button class="try-another-btn" onclick="tryAnotherLook()">Try another look</button>
    </div>
  </div>

  <div class="section">
    <h3>Log</h3>
    <div id="log" class="log"></div>
  </div>

  <script>
    let currentJobId = null;
    let pollInterval = null;
    let submitTimestamp = null;

    function log(message, type = 'info') {
      const logEl = document.getElementById('log');
      const time = new Date().toLocaleTimeString();
      const entry = document.createElement('div');
      entry.className = 'log-entry';
      entry.innerHTML = `<span class="log-time">[${time}]</span> <span class="log-${type}">${message}</span>`;
      logEl.insertBefore(entry, logEl.firstChild);
    }

    function getBaseUrl() {
      return document.getElementById('baseUrl').value || '';
    }

    async function checkHealth() {
      log('Checking async jobs health...', 'info');
      try {
        const res = await fetch(`${getBaseUrl()}/api/jobs/health`);
        const data = await res.json();
        if (res.ok) {
          log(`‚úÖ Health OK: ${JSON.stringify(data)}`, 'success');
        } else {
          log(`‚ùå Health FAIL: ${JSON.stringify(data)}`, 'error');
        }
      } catch (err) {
        log(`‚ùå Health error: ${err.message}`, 'error');
      }
    }

    async function submitJob() {
      const apiKey = document.getElementById('apiKey').value;
      const userImage = document.getElementById('userImage').value;
      const garmentImage = document.getElementById('garmentImage').value;

      if (!userImage || !garmentImage) {
        log('Please provide both user and garment images', 'error');
        return;
      }

      // Reset state
      if (pollInterval) clearInterval(pollInterval);
      document.getElementById('resultContainer').style.display = 'none';
      document.getElementById('timings').style.display = 'none';

      log('Submitting async job...', 'info');
      submitTimestamp = Date.now();

      try {
        const res = await fetch(`${getBaseUrl()}/api/jobs/submit`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            apiKey,
            userImage,
            garments: [garmentImage]
          })
        });

        const data = await res.json();
        const submitDuration = Date.now() - submitTimestamp;

        if (!res.ok) {
          log(`‚ùå Submit failed: ${JSON.stringify(data)}`, 'error');
          return;
        }

        currentJobId = data.job_id;
        log(`‚úÖ Job submitted in ${submitDuration}ms: ${currentJobId}`, 'success');
        
        document.getElementById('submitTime').textContent = submitDuration;
        document.getElementById('timings').style.display = 'grid';
        
        updateStatus({ status: 'queued' });
        
        // Start polling
        pollInterval = setInterval(pollStatus, 2000);
        pollStatus(); // Immediate first poll

      } catch (err) {
        log(`‚ùå Submit error: ${err.message}`, 'error');
      }
    }

    async function pollStatus() {
      if (!currentJobId) return;

      try {
        const res = await fetch(`${getBaseUrl()}/api/jobs/${currentJobId}/status`);
        const data = await res.json();

        if (!res.ok) {
          log(`‚ö†Ô∏è Status error: ${JSON.stringify(data)}`, 'warn');
          return;
        }

        updateStatus(data);

        // Update timings
        const ts = data.timestamps;
        if (ts.fal_start && ts.created_at) {
          document.getElementById('queueTime').textContent = ts.fal_start - ts.created_at;
        }
        if (ts.fal_end && ts.fal_start) {
          document.getElementById('falTime').textContent = ts.fal_end - ts.fal_start;
        }
        if (ts.completed_at && ts.created_at) {
          const total = ts.completed_at - ts.created_at;
          document.getElementById('totalTime').textContent = total;
        }

        // Check if done
        if (data.status === 'done') {
          clearInterval(pollInterval);
          log(`üéâ Job completed! Image URL: ${data.image_url.substring(0, 50)}...`, 'success');
          
          document.getElementById('resultImage').src = data.image_url;
          document.getElementById('resultContainer').style.display = 'block';
          
          // Show thumbnails
          const userImg = document.getElementById('userImage').value;
          const garmentImg = document.getElementById('garmentImage').value;
          document.getElementById('thumbUser').src = userImg.startsWith('data:') ? userImg : userImg;
          document.getElementById('thumbGarment').src = garmentImg.startsWith('data:') ? garmentImg : garmentImg;
        }

        if (data.status === 'error') {
          clearInterval(pollInterval);
          log(`‚ùå Job failed: ${data.error}`, 'error');
        }

      } catch (err) {
        log(`‚ö†Ô∏è Poll error: ${err.message}`, 'warn');
      }
    }

    function updateStatus(data) {
      const statusEl = document.getElementById('jobStatus');
      const badge = `<span class="status-badge status-${data.status}">${data.status}</span>`;
      statusEl.innerHTML = `Job: <code>${currentJobId}</code> ${badge}`;
      log(`Status: ${data.status}`, data.status === 'done' ? 'success' : 'info');
    }

    function closeResult() {
      document.getElementById('resultContainer').style.display = 'none';
    }

    function tryAnotherLook() {
      document.getElementById('resultContainer').style.display = 'none';
      document.getElementById('garmentImage').value = '';
      document.getElementById('garmentImage').focus();
      log('Ready for a new garment!', 'info');
    }

    function addAnotherGarment() {
      log('Adding another garment is not yet supported (1 garment max for speed)', 'warn');
    }

    // Check health on load
    window.onload = () => {
      checkHealth();
    };
  </script>
</body>
</html>
